# План реализации Unity Addressables - Уровень 2 (Продвинутый)

## Общая информация
- **Проект**: TestTaskAdressables
- **Уровень сложности**: 2 (Продвинутый)
- **Платформы**: WebGL и Android
- **Время реализации**: ~12-15 часов
- **Архитектурный подход**: GameTemplate + Zenject + UniTask + R3

---

## Этап 1: Архитектура Addressables (3-4 часа)

### ✅ Коммит 1.1: `feat: setup addressable profiles and groups structure` - ВЫПОЛНЕН

**Задачи:**
- ✅ Создание папочной структуры для Addressable ресурсов
- ✅ Базовые интерфейсы и модели для сервисов

**Unity Инструкции:**
```
1. ИНИЦИАЛИЗАЦИЯ ADDRESSABLES:
   Window → Asset Management → Addressables → Groups
   Нажать "Create Addressables Settings"

2. СОЗДАНИЕ ПРОФИЛЕЙ:
   В Addressables Groups окне:
   - Profile dropdown (справа сверху) → "Manage Profiles"
   - Create → Profile → назвать "Development"
   - В профиле Development изменить переменные:
     * RemoteLoadPath: http://localhost:8080/[BuildTarget]
     * BuildPath: ServerData/[BuildTarget]
   
   - Create → Profile → назвать "Staging"
   - В профиле Staging:
     * RemoteLoadPath: https://staging.yourcdn.com/[BuildTarget]  
     * BuildPath: ServerData/[BuildTarget]
   
   - Create → Profile → назвать "Production"
   - В профиле Production:
     * RemoteLoadPath: https://cdn.yourprod.com/[BuildTarget]
     * BuildPath: ServerData/[BuildTarget]

3. СОЗДАНИЕ ГРУПП:
   В Addressables Groups окне нажать "New" → "Packed Assets":

   ГРУППА "Core_Local":
   - Переименовать группу в "Core_Local"
   - Content Packing & Loading → Bundle Mode: Pack Together
   - Content Packing & Loading → Compression: LZ4
   - Content Update Restriction → Include in Build: ✓
   - Build and Load Paths → Build Path: [UnityEngine.AddressableAssets.Addressables.BuildPath]/[BuildTarget]
   - Build and Load Paths → Load Path: [UnityEngine.AddressableAssets.Addressables.RuntimePath]/[BuildTarget]

   ГРУППА "UI_Remote":
   - Создать новую группу "UI_Remote" 
   - Bundle Mode: Pack Separately
   - Compression: LZ4  
   - Include in Build: ✗
   - Build Path: [AddressablesRemoteBuildPath]/[BuildTarget]
   - Load Path: [AddressablesRemoteLoadPath]/[BuildTarget]

   ГРУППА "Characters_Remote":
   - Bundle Mode: Pack Together By Label
   - Compression: LZMA
   - Include in Build: ✗
   - Build & Load Paths: Remote paths

   ГРУППА "Environment_Remote":
   - Bundle Mode: Pack Together
   - Compression: LZMA
   - Include in Build: ✗
   - Build & Load Paths: Remote paths

   ГРУППА "Effects_Remote":
   - Bundle Mode: Pack Separately
   - Compression: LZ4
   - Include in Build: ✗
   - Build & Load Paths: Remote paths

   ГРУППА "Levels_Remote":
   - Bundle Mode: Pack Together By Label
   - Compression: LZMA
   - Include in Build: ✗
   - Build & Load Paths: Remote paths
```

**✅ Созданные файлы:**
- ✅ `Assets/Project/Scripts/Core/Services/Addressable/IAddressableService.cs`
- ✅ `Assets/Project/Scripts/Core/Services/Addressable/Models/LoadingData.cs`
- ✅ `Assets/Project/Scripts/Core/Services/Addressable/Models/AddressableSettings.cs`

### ✅ Коммит 1.2: `feat: implement addressable labels and asset organization` - ВЫПОЛНЕН

**Задачи:**
- ✅ Создание структуры папок AddressableAssets
- ✅ Система меток (Labels)
- ✅ Конфигурационные ScriptableObject'ы

**Unity Инструкции:**
```
1. СОЗДАНИЕ СТРУКТУРЫ ПАПОК:
   В Project окне создать:
   Assets/AddressableAssets/
   ├── Core/ 
   ├── Characters/
   ├── Environment/
   ├── Effects/
   └── Levels/

2. СОЗДАНИЕ LABELS:
   Window → Asset Management → Addressables → Labels
   Создать метки:
   - core, ui, character, environment, effect, level
   - audio, texture, prefab, scene

3. НАЗНАЧЕНИЕ РЕСУРСОВ В ГРУППЫ:
   Выделить ресурсы → Inspector → Addressable ✓
   
   ДЛЯ CORE_LOCAL:
   - Основные UI префабы → Group: Core_Local, Address: ui_main_menu
   - Базовые материалы → Group: Core_Local, Address: material_default  
   - Критичные звуки → Group: Core_Local, Address: audio_click_sound

   ДЛЯ UI_REMOTE:
   - UI экраны → Group: UI_Remote, Labels: ui
   - Address examples: ui_settings_panel, ui_shop_window

   ДЛЯ CHARACTERS_REMOTE:
   - Префабы персонажей → Group: Characters_Remote, Labels: character
   - Address: characters_player_prefab, characters_enemy_01

   ДЛЯ LEVELS_REMOTE:
   - Сцены уровней → Group: Levels_Remote, Labels: level + scene
   - Address: levels_level01_scene, levels_level02_scene
```

**✅ Созданные файлы:**
- ✅ `Assets/Project/Scripts/Core/Config/Addressable/AddressableConfig.cs`
- ✅ `Assets/Project/Scripts/Core/Config/Addressable/IAddressableConfigRepository.cs`
- ✅ `Assets/Project/Scripts/Core/Config/Addressable/AddressableConfigRepository.cs`
- ✅ `Assets/Project/Scripts/Core/Services/Addressable/AddressableKeys.cs`
- ✅ README файлы для всех папок AddressableAssets

### ✅ Коммит 1.3: `feat: configure separate catalogs for content updates` - ВЫПОЛНЕН

**Задачи:**
- Настройка Content Update Workflow
- Отдельные каталоги для разных групп
- Platform-specific настройки

**Unity Инструкции:**
```
1. НАСТРОЙКА CONTENT UPDATES:
   Addressables Groups → выбрать Levels_Remote группу
   Inspector → Content Update Restriction:
   - Can Change Post Release: ✓
   - Include in Build: ✗
   
2. НАСТРОЙКА ОТДЕЛЬНОГО КАТАЛОГА:
   Addressables Groups → Levels_Remote → Inspector
   Advanced Options → Use Separate Catalog: ✓
   Catalog Name: catalog_levels

3. PLATFORM SETTINGS:
   Addressables Groups → Tools → Preferences

   WebGL Settings:
   - Max Concurrent Web Requests: 6
   - Catalog Download Timeout: 30
   - Disable Catalog Update on Start: false

   Android Settings:  
   - Use Asset Database: false (только true в Development)
   - Simulate Groups: false (только true в Development)

4. BUILD SETTINGS:
   Addressables Groups → Build → New Build → Default Build Script
   Создать кастомный билд скрипт (опционально)
```

---

## Этап 2: Интеграция с GameTemplate (2-3 часа)

### Коммит 2.1: `feat: create addressable service layer with zenject integration`

**Задачи:**
- Основной сервис загрузки с UniTask
- Интеграция с Zenject DI
- Repository pattern для конфигураций

**Unity Инструкции:**
```
1. СОЗДАНИЕ SCRIPTABLEOBJECT CONFIG:
   Assets/Project/Configs/ → Create → Project Config → AddressableConfig
   Настроить параметры:
   - Default Profile: "Default"
   - Development Profile: "Development"
   - Production Profile: "Production" 
   - Enable Retry: true
   - Max Retries: 3
   - Retry Delay: 1.0
   - Enable Caching: true
   - Max Cache Size MB: 100

2. ZENJECT INTEGRATION:
   Найти ProjectContext prefab в Resources/
   ProjectServiceInstaller → добавить биндинги для новых сервисов
   
3. ТЕСТИРОВАНИЕ СЕРВИСОВ:
   Создать тестовую сцену
   Добавить GameObject с тестовым скриптом
```

**Файлы для создания:**
- `Assets/Project/Scripts/Core/Services/Addressable/AddressableService.cs`
- `Assets/Project/Scripts/Core/Installers/AddressableServiceInstaller.cs`

### Коммит 2.2: `feat: implement loading service with progress tracking`

**Задачи:**
- Сервис UI прогресса загрузки
- Observable события с R3
- Интеграция с существующими сервисами

**Unity Инструкции:**
```
1. ИНТЕГРАЦИЯ С СУЩЕСТВУЮЩИМИ СЕРВИСАМИ:
   Открыть SceneManagerService.cs
   Добавить методы для Addressable загрузки сцен
   
2. UI SERVICE INTEGRATION:
   UIPageService → добавить поддержку LoadingProgressView
   
3. TESTING:
   Main сцена → добавить тестовые кнопки для загрузки
```

**Файлы для создания:**
- `Assets/Project/Scripts/Core/Services/Loading/ILoadingService.cs`
- `Assets/Project/Scripts/Core/Services/Loading/LoadingService.cs`

### Коммит 2.3: `feat: add addressable config and memory management`

**Задачи:**
- Memory management с автоматической выгрузкой
- R3 Observable для событий системы
- Расширение существующих сервисов

**Unity Инструкции:**
```
1. СОЗДАНИЕ CONFIG ASSET:
   Assets/Project/Configs/AddressableConfig.asset
   Заполнить все параметры из кода
   
2. MEMORY PROFILER SETUP:
   Window → Analysis → Memory Profiler
   Подключить для отслеживания утечек памяти
   
3. R3 INTEGRATION:
   Проверить подписки на Observable события
   Тестировать auto-dispose при смене сцены
```

---

## Этап 3: UI и диагностика (2-3 часа)

### Коммит 3.1: `feat: implement loading progress view with animations`

**Задачи:**
- UI компонент прогресс-бара
- DOTween анимации
- Интеграция в Core_Local группу

**Unity Инструкции:**
```
1. СОЗДАНИЕ PROGRESS VIEW PREFAB:
   GameObject → UI → Canvas → LoadingProgressView
   Добавить компоненты:
   - Background: Image (черный, Alpha 0.7)
   - ProgressBar: Slider (Fill Area → Fill → Image)
   - TitleText: TextMeshPro "Loading..."
   - StatusText: TextMeshPro "Downloading assets..."  
   - PercentageText: TextMeshPro "0%"

2. DOTWEEN АНИМАЦИИ:
   ProgressBar → DOFillAmount для плавного заполнения
   Title → DOFade для появления/исчезновения
   Background → DOFade для fade in/out эффекта

3. ДОБАВИТЬ В CORE_LOCAL:
   Prefab → Inspector → Addressable ✓
   Group: Core_Local
   Address: ui_loading_progress
   Labels: ui, core

4. SAVE AS PREFAB:
   Assets/Project/Prefabs/UI/LoadingProgressView.prefab
```

**Файлы для создания:**
- `Assets/Project/Scripts/UI/Addressable/LoadingProgressView.cs`

### Коммит 3.2: `feat: create dev overlay panel for debugging`

**Задачи:**
- Отладочная панель для разработчиков
- Управление кешем и профилями
- Статистика системы

**Unity Инструкции:**
```
1. СОЗДАНИЕ DEV OVERLAY PREFAB:
   Canvas → DevOverlayView (UI элементы в углу экрана)
   
   Кнопки:
   - "Clear Cache" Button
   - "Switch Profile" Dropdown (Dev/Staging/Production)
   - "Show Memory" Button  
   - "Download All" Button
   
   Info Panel:
   - "Profile: Development" Text
   - "Catalog: v1.2.3" Text
   - "Assets: 15/32" Text
   - "Cache: 45/100 MB" Text

2. CONDITIONAL COMPILATION:
   DevOverlay GameObject → active только если DEVELOPMENT define

3. ДОБАВИТЬ В CORE_LOCAL:
   Address: ui_dev_overlay
   Labels: ui, core
   
4. INTEGRATION:
   Связать кнопки с AddressableService методами через DevOverlayView.cs
```

**Файлы для создания:**
- `Assets/Project/Scripts/UI/Addressable/DevOverlayView.cs`

### Коммит 3.3: `feat: add telemetry and error handling system`

**Задачи:**
- Система телеметрии загрузок
- Error handling с retry логикой
- Diagnostic events integration

**Unity Инструкции:**
```
1. ADDRESSABLES EVENTS SETUP:
   AddressableService → подписаться на ResourceManager events
   Console для просмотра логов телеметрии

2. ERROR HANDLING TESTING:
   Отключить интернет → тестировать offline режим
   Изменить URL на невалидный → тестировать network errors
   
3. RETRY LOGIC VERIFICATION:
   Console → наблюдать retry attempts с exponential backoff
   Проверить Circuit Breaker после 5 ошибок подряд
```

---

## Этап 4: Оптимизация (1-2 часа)

### Коммит 4.1: `feat: optimize bundle settings and compression`

**Задачи:**
- Анализ дубликатов в бандлах
- Оптимизация Bundle Mode и Compression
- Соблюдение бюджетов размера

**Unity Инструкции:**
```
1. ANALYZE DEPENDENCIES:
   Addressables Groups → Tools → Analyze
   - Check Duplicate Bundle Dependencies
   - Bundle Layout Preview
   
   Исправить найденные дубликаты:
   - Общие материалы → отдельная SharedAssets группа
   - Повторяющиеся текстуры → SharedTextures группа

2. COMPRESSION OPTIMIZATION:
   Для каждой группы проверить Bundle Mode и Compression:
   - Частые ресурсы (UI, Effects) → LZ4 (быстрая распаковка)
   - Редкие ресурсы (Characters, Environment) → LZMA (лучшее сжатие)

3. BUNDLE SIZE VERIFICATION:
   После билда проверить ServerData/WebGL/ размеры файлов
   Цель: каждый бандл < 10MB для WebGL
```

### Коммит 4.2: `feat: implement platform-specific optimizations`

**Задачи:**
- WebGL специфичные настройки
- Android оптимизации
- Graceful degradation при ошибках

**Unity Инструкции:**
```
1. WEBGL OPTIMIZATION:
   Build Settings → WebGL
   Player Settings:
   - Publishing Settings → Compression Format: Brotli
   - Publishing Settings → Decompression Fallback: ✓
   
   Addressables Settings:
   - Max Concurrent Web Requests: 6
   - Catalog Download Timeout: 30s

2. ANDROID OPTIMIZATION:  
   Build Settings → Android
   Player Settings:
   - Publishing Settings → Build App Bundle: ✓
   - Configuration: Master
   
   Addressables Settings:
   - Use Asset Database: false
   - Simulate Groups: false

3. TESTING NETWORK CONDITIONS:
   Chrome DevTools → Network tab → Slow 3G
   Тестировать загрузку на медленном соединении
```

### Коммит 4.3: `feat: create test scenarios and demo content`

**Задачи:**
- Демо контент для тестирования
- Тестовые скрипты и сценарии
- Локальный сервер для разработки

**Unity Инструкции:**
```
1. СОЗДАНИЕ DEMO КОНТЕНТА:
   Assets/AddressableAssets/ добавить:
   - UI_Remote: 3-5 тестовых спрайтов разного размера
   - Characters_Remote: 1 тестовый персонаж префаб
   - Levels_Remote: 2 простые тестовые сцены
   
   Назначить Addressable адреса:
   - ui_test_button_01, ui_test_icon_big
   - character_test_hero
   - level_test_01, level_test_02

2. СОЗДАНИЕ TEST SCRIPT:
   GameObject → AddressableTest
   Добавить компонент с тестовым кодом
   Кнопки для каждого тест-кейса

3. LOCAL SERVER SETUP:
   Терминал в папке проекта:
   cd ServerData
   python -m http.server 8080
   
   Проверить доступность: http://localhost:8080/WebGL/
```

**Файлы для создания:**
- `Assets/Project/Scripts/Testing/AddressableTest.cs`

---

## Финальные коммиты

### Коммит 5.1: `feat: build webgl and android versions`

**Задачи:**
- Production билды для обеих платформ
- Deployment на хостинг
- CDN конфигурация

**Unity Инструкции:**
```
1. WEBGL BUILD:
   File → Build Settings → WebGL
   Player Settings оптимизация:
   - Resolution: Run in Background ✓
   - Publishing: Compression Format: Brotli
   - Publishing: Name Files As Hashes: ✓
   - Other: Strip Engine Code: ✓
   
   Addressables Build:
   - Profile: Production
   - Build → New Build → Default Build Script
   - Дождаться завершения сборки Addressables
   
   Unity Build:
   - Build Settings → Build
   - Выбрать папку WebGLBuild/

2. ANDROID BUILD:
   File → Build Settings → Android  
   Player Settings:
   - Configuration: Master
   - Scripting Backend: IL2CPP
   - Target Architectures: ARM64
   
   Build APK или AAB

3. DEPLOYMENT:
   ServerData/ → загрузить на GitHub Pages или itch.io
   Обновить Production profile URL на реальный CDN
```

### Коммит 5.2: `docs: add implementation report and readme`

**Задачи:**
- Технический отчет с замерами
- Документация архитектуры
- Инструкции по использованию

**Unity Инструкции:**
```
1. ЗАМЕРЫ ПРОИЗВОДИТЕЛЬНОСТИ:
   Memory Profiler → сделать снимки до/после загрузки
   Console → скопировать логи телеметрии
   
2. BUNDLE ANALYSIS:
   ServerData/WebGL/ → записать размеры всех бандлов
   Build Report → скопировать статистику
   
3. TESTING CHECKLIST:
   ✅ Первый запуск без кеша
   ✅ Content update без релиза приложения  
   ✅ Network error recovery
   ✅ Profile switching
   ✅ Cache clearing
   
4. СОЗДАНИЕ ОТЧЕТА:
   Документировать все замеры и решения в Markdown файле
```

---

## Критерии успеха

### Функциональные требования:
- ✅ Корректность контент-обновлений без релиза клиента
- ✅ Наблюдаемость: полнота телеметрии, удобство Dev Overlay
- ✅ Устойчивость к сетевым ошибкам и качество UX при деградации
- ✅ Фактические метрики размера и времени, соответствие бюджетам

### Технические требования:
- ✅ Архитектура групп и зависимостей, аргументация Bundle Mode и компрессии
- ✅ Читаемость кода, отсутствие утечек handle, осмысленная выгрузка
- ✅ Интеграция с GameTemplate паттернами (Zenject, UniTask, R3)

### Бюджеты производительности:
- **WebGL**: Первый запуск ≤ 20-30 МБ по сети
- **Android**: Первый запуск ≤ 10-15 МБ по сети
- **Время до интерактива**: ≤ 10 секунд на 3G соединении
- **Memory usage**: корректная выгрузка неиспользуемых ресурсов

---

## Структура файлов проекта

```
Assets/Project/Scripts/Core/
├── Services/Addressable/
│   ├── IAddressableService.cs          # ✅ Интерфейс основного сервиса
│   ├── AddressableService.cs           # Реализация загрузки ресурсов
│   ├── AddressableKeys.cs              # ✅ Константы ключей и меток
│   └── Models/
│       ├── LoadingData.cs              # ✅ Модель данных загрузки
│       └── AddressableSettings.cs      # ✅ Настройки системы
├── Services/Loading/
│   ├── ILoadingService.cs              # Интерфейс UI прогресса
│   └── LoadingService.cs               # Реализация UI прогресса
├── Config/Addressable/
│   ├── AddressableConfig.cs            # ✅ ScriptableObject конфиг
│   ├── IAddressableConfigRepository.cs # ✅ Интерфейс репозитория
│   └── AddressableConfigRepository.cs  # ✅ Реализация репозитория
└── Installers/
    └── AddressableServiceInstaller.cs  # Zenject инсталлер

Assets/Project/Scripts/UI/Addressable/
├── LoadingProgressView.cs              # UI экран загрузки
└── DevOverlayView.cs                   # Отладочная панель

Assets/Project/Scripts/Testing/
└── AddressableTest.cs                  # Тестовый скрипт

Assets/AddressableAssets/               # ✅ Addressable настройки
├── Core/                              # ✅ Критичные ресурсы (в билде)
├── Characters/                        # ✅ Персонажи (удаленно)
├── Environment/                       # ✅ Окружение (удаленно)
├── Effects/                          # ✅ Эффекты (удаленно)
└── Levels/                           # ✅ Уровни (удаленно)
```

---

## Статус выполнения: 2/11 коммитов ✅

**Выполнено**: Коммиты 1.1 и 1.2  
**Текущий**: Коммит 1.3 - configure separate catalogs for content updates
